/*! Aleph v1.0.0 | (c) 2014 Aleph Tav <4lephtav@gmail.com> | http://www.opensource.org/licenses/MIT */
var CONTAINER_PREFIX="cont-";var Control=function(e){var t=function(e,t){this.el=e;this.pom=t;this.events={}};var n=function(e,t,n,r){var i,s,o=e.get(0).attributes;for(i=o.length-1;i>=0;i--){s=o[i].name;if(r.indexOf(s)<0)t[n+(s.substr(0,5)=="data-"?s.substr(5):s)]=e.attr(s)}};t.prototype.vs=function(t){t=t||[];t.push("id");t.push("data-ctrl");var r={attrs:{}};if(this.el.get(0)["value"]!=e)r["value"]=this.value();n(this.el,r["attrs"],"",t);var i=$("#"+CONTAINER_PREFIX+this.el.attr("id"));if(i.length)n(i,r["attrs"],CONTAINER_PREFIX,t);return r};t.prototype.container=function(){var e=$("#"+CONTAINER_PREFIX+this.el.attr("id"));return e.length?e:this.el};t.prototype.type=function(){return this.el.attr("data-ctrl")};t.prototype.value=function(){return this.el.val()};t.prototype.clean=function(){this.el.val("");return this};t.prototype.focus=function(){this.el.focus();return this};t.prototype.validate=function(e){return true};t.prototype.init=function(){this.el=$("#"+this.el.attr("id"));return this.refreshEvents()};t.prototype.refreshAttributes=function(e,t){var n=this.container(),r=CONTAINER_PREFIX.length;for(var i in t){i=t[i];if(i.substr(0,r)!=CONTAINER_PREFIX)this.el.removeAttr(i);else n.removeAttr(i.substr(r))}var s;for(var i in e){s=e[i];if(i.substr(0,r)!=CONTAINER_PREFIX){if(i=="checked")this.el.prop(i,s);this.el.attr(i,s)}else{if(i=="checked")n.prop(i.substr(r),s);n.attr(i.substr(r),s)}}return this};t.prototype.refresh=function(e,t){if(typeof e=="object"){this.refreshAttributes(e,t)}else{var n=this.el.attr("id");this.container().replaceWith(e);this.el=$("#"+n)}return this.init()};t.prototype.remove=function(){this.removeEvents(true);this.container().remove();return this};t.prototype.bind=function(t,n,r,i,s,o){this.unbind(t);this.addEvent(t,n,r,i,s,o);if(!i||i()){var u=s?$("#"+CONTAINER_PREFIX+this.el.attr("id")):this.el;if(o!=e)u.on(n,o,r);else u.on(n,r)}return this};t.prototype.unbind=function(e){this.removeEvent(e);delete this.events[e];return this};t.prototype.addEvent=function(e,t,n,r,i,s){this.events[e]={type:t,callback:n,check:r,toContainer:i,data:s};return this};t.prototype.removeEvent=function(t){var n=this.events[t];if(n!=e)(n.toContainer?$("#"+CONTAINER_PREFIX+this.el.attr("id")):this.el).off(n.type,n.callback);return this};t.prototype.removeEvents=function(e){this.el.off();$("#"+CONTAINER_PREFIX+this.el.attr("id")).off();if(e)this.events={};return this};t.prototype.restoreEvents=function(){var t,n,r=$("#"+CONTAINER_PREFIX+this.el.attr("id"));for(var i in this.events){t=this.events[i];if(!t.check||t.check()){n=t.toContainer?r:this.el;if(t.data!=e)n.on(t.type,t.data,t.callback);else n.on(t.type,t.callback)}}return this};t.prototype.refreshEvents=function(){return this.removeEvents().restoreEvents()};return t}();var POM=function(e){var t={},n={},r={};var i=function(e,t){var n=function(){};n.prototype=t.prototype;e.prototype=new n;e.prototype.constructor=e;e.superclass=t.prototype;return e};var s=function(){};s.prototype.registerControl=function(e,t,r){return n[e]=i(t,r||Control)};s.prototype.registerValidator=function(e,t,r){return n[e]=i(t,r||Validator)};s.prototype.get=function(t,i){if(!i&&r[t])return r[t];var s=$("#"+t,i);if(s.length==0){if(!i){for(var o in r){if(r[o].el.attr("data-fullid").substr(-t.length)==t)return r[o]}}s=$("[data-fullid$='"+t+"'][data-ctrl]",i);if(s.length==0){if(!i)delete r[t];return false}s=$(s.get(0))}t=s.attr("id");if(t=="")return false;if(r[t])return r[t];var u=s.attr("data-ctrl").toLowerCase();if(n[u]==e)return false;return r[t]=(new n[u](s,this)).init()};s.prototype.setVS=function(){t={};var e=this;$("[data-ctrl]").each(function(){var n=e.get(this.id);if(n)t[this.id]=n.vs()});return this};s.prototype.getVS=function(){var n={};var r=this;$("[data-ctrl]").each(function(i,s){var o=r.get(s.id).vs();if(typeof t[s.id]=="undefined")n[s.id]=o;else{n[s.id]={};for(var u in o["attrs"]){if(JSON.stringify(t[s.id]["attrs"][u])!==JSON.stringify(o["attrs"][u])){if(n[s.id]["attrs"]==e)n[s.id]["attrs"]={};n[s.id]["attrs"][u]=o["attrs"][u]}}for(var u in t[s.id]["attrs"]){if(o["attrs"][u]==e){if(n[s.id]["removed"]==e)n[s.id]["removed"]=[];n[s.id]["removed"].push(u)}}if(JSON.stringify(t[s.id]["value"])!==JSON.stringify(o["value"]))n[s.id]["value"]=o["value"];if(n[s.id]["attrs"]==e&&n[s.id]["removed"]==e&&n[s.id]["value"]==e)delete n[s.id]}});return{ts:(new Date).valueOf(),vs:n}};s.prototype._refreshPOMTree=function(e){var n,i,s;s=e.created;for(n in s){i=this.get(n);if(i){i.remove();delete r[n];delete e.removed[n]}}for(n in s){var o=s[n]["mode"],u=s[n]["id"],a=s[n]["html"];if(!o||!u)continue;i=$("#"+CONTAINER_PREFIX+u).length&&$("[id='"+u+"'][data-ctrl]").length?"#"+CONTAINER_PREFIX+u:"#"+u;switch(o){case"top":$(i).prepend(a);break;case"bottom":$(i).append(a);break;case"before":$(i).before(a);break;case"after":$(i).after(a);break;case"replace":delete r[u];delete t[u];$(i).replaceWith(a);break}i=$("#"+CONTAINER_PREFIX+n).length&&$("[id='"+n+"'][data-ctrl]").length?"#"+CONTAINER_PREFIX+n:"#"+n;$("[data-ctrl]",i).each(function(){delete r[this.id]})}s=e.removed;for(n in s){i=this.get(n);if(i){i.remove();delete r[n]}}s=e.refreshed;var f,l,c={};for(n in s){i=this.get(n);if(!i){delete s[n];continue}if(i.getControls&&typeof s[n]!="object"){for(f in c){if(i.has(c[f])){delete c[f]}}c[n]=i}}for(n in s){i=this.get(n);for(f in c){if(c[f].has(i)){delete s[n];break}}}for(n in s){i=this.get(n);if(typeof s[n]=="object")i.refresh(s[n]["attrs"],s[n]["removed"]);else i.refresh(s[n])}return this};s.prototype.getValidators=function(e){var t=[],n=this;if(e=="*"){$("[data-groups][data-controls]").each(function(){var e=n.get($(this).attr("id"));if(e&&!e.isLocked())t.push(e)})}else{e=(e||"default").split(/\s*,\s*/);$("[data-groups][data-controls]").each(function(){var r=n.get($(this).attr("id"));if(r&&!r.isLocked()&&r.hasGroup(e))t.push(r)})}return t};s.prototype.validate=function(t,n,r){var i=this.getValidators(t);i.sort(function(e,t){return e.getIndex()-t.getIndex()});var s,o,u,a,f,l,c,h=true,p={};for(s=0;s<i.length;s++){a=i[s];if(a.validate()){for(o in a.result){if(p[o]==e)p[o]=true}}else{h=false;for(var o in a.result){if(!a.result[o])p[o]=false;else if(p[o]==e)p[o]=true}}}for(o in p){u=$("#"+CONTAINER_PREFIX+o);u=u.length>0?u:$("#"+o);if(p[o])u.removeClass(n).addClass(r);else{if(u.css("display")=="none"){l=u.show().offset();u.hide()}else{l=u.offset()}u.removeClass(r).addClass(n);if(!f||c.top>l.top||c.top==l.top&&c.left>l.left){f=u;c=l}}}if(f){u=this.get(f.attr("id"));if(u)u.focus();else f.focus()}return h};s.prototype.reset=function(e,t,n){var r,i=this.getValidators(e);$.each(i,function(e,i){var s=i.getControls();for(var o=0;o<s.length;o++){r=$("#"+CONTAINER_PREFIX+s[o]);r=r.length>0?r:$("#"+s[o]);r.removeClass(t).addClass(n)}i.setState(true)});return this};return s}();var $pom=new POM;$(function(){$pom.setVS()});var Ajax=function(e){var t,n,r={};var i=function(){n=document.body.style.cursor;document.body.style.cursor="wait"};var s=function(){document.body.style.cursor=n};var o=function(e){this.pom=e;this.setup({global:true,type:"POST",url:window.location.href,ajaxStart:i,ajaxStop:s,dataFilter:function(t,n){if($.type(t)=="object")t=$(t[0].body).text();if(t.length==0){e.setVS();return"null"}var r=t.substr(0,13);var i,s=t.lastIndexOf(r);if(s<1)i=t;else i=t.substr(13,s-13);if(i.length)$.globalEval(i);e.setVS();return s>0?t.substr(s+13):"null"}})};o.prototype.setup=function(e,n){if(n){t=e;return this}if(e.global){if(e.ajaxStart)$(document).ajaxStart(e.ajaxStart);if(e.ajaxStop)$(document).ajaxStop(e.ajaxStop);if(e.ajaxComplete)$(document).ajaxComplete(e.ajaxComplete);if(e.ajaxError)$(document).ajaxError(e.ajaxError);if(e.ajaxSuccess)$(document).ajaxSuccess(e.ajaxSuccess);if(e.ajaxSend)$(document).ajaxSend(e.ajaxSend)}$.ajaxSetup(e);return this};o.prototype.doit=function(e){var n={"ajax-method":e,"ajax-args":Array.prototype.slice.call(arguments,1),"ajax-key":$(document.body).attr("id"),"ajax-vs":this.pom.getVS()};var r={data:n};if(t){r=t;r.data=n;t=null}return $.ajax(r)};o.prototype.submit=function(e,t,n,i){if(!r[e]&&this.pom.validate(t,n,i)){r[e]=true;return this.doit.apply(this,$.merge([e],Array.prototype.slice.call(arguments,4))).always(function(){delete r[e]})}return false};o.prototype.action=function(e){var t,n=Array.prototype.slice.call(arguments,1);e=e.toLowerCase();switch(e){case"reload":t=0;break;case"alert":case"redirect":case"focus":case"remove":case"script":t=1;break;case"display":case"message":case"inject":t=3;break;default:t=2;break}t=typeof n[t]=="undefined"?0:n[t];var r=function(){switch(e){case"alert":alert(n[0]);break;case"redirect":window.location.assign(n[0]);break;case"reload":window.location.reload(true);break;case"display":if(typeof n[1]=="undefined")n[1]=$(n[0]).css("display")=="none"?"":"none";if(typeof n[2]=="undefined"||n[2]==0)$(n[0]).css("display",n[1]);else{var t=$(n[0]).css("display");$(n[0]).css("display",n[1]);setTimeout(function(){$(n[0]).css("display",t)},n[2])}break;case"message":if(typeof n[2]=="undefined"||n[2]==0)$(n[0]).html(n[1]);else{var r=$(n[0]).html();$(n[0]).html(n[1]);setTimeout(function(){$(n[0]).html(r)},n[2])}break;case"focus":$(n[0]).focus();break;case"addclass":$(n[0]).addClass(n[1]);break;case"removeclass":$(n[0]).removeClass(n[1]);break;case"toggleclass":$(n[0]).toggleClass(n[1]);break;case"remove":$(n[0]).remove();break;case"insert":$(n[0]).html(n[1]);break;case"replace":$(n[0]).replaceWith(n[1]);break;case"inject":switch(n[2].toLowerCase()){case"top":$(n[0]).prepend(n[1]);break;case"botom":$(n[0]).append(n[1]);break;case"before":$(n[0]).before(n[1]);break;case"after":$(n[0]).after(n[1]);break}break;case"script":$.globalEval(n[0]);break}};t>0?setTimeout(r,t):r()};return o}();var $ajax=new Ajax($pom);var Any=function(e,t){Any.superclass.constructor.call(this,e,t)};$pom.registerControl("any",Any);var Input=function(e,t){Input.superclass.constructor.call(this,e,t);this.validate=function(e){return e.check(this.value())}};$pom.registerControl("input",Input);var Hidden=function(e,t){Hidden.superclass.constructor.call(this,e,t)};$pom.registerControl("hidden",Input);var TextBox=function(e,t){TextBox.superclass.constructor.call(this,e,t);var n=e.attr("id");var r=function(){var e=$(this);if(e.val()==e.attr("data-default"))e.val("")};var i=function(){var e=$(this);if(!e.val())e.val(e.attr("data-default"))};var s=function(){return!!$("#"+n).attr("data-default")};this.addEvent(n+"_txt_e1","focus",r,s);this.addEvent(n+"_txt_e2","blur",i,s);this.init=function(){TextBox.superclass.init.call(this);var e=this.el.attr("data-default");if(e)if(!this.el.val())this.el.val(e);return this};this.refresh=function(e,t){r.call(this.el);return TextBox.superclass.refresh.call(this,e,t)};this.validate=function(e){return e.check(this.value())};this.clean=function(){this.el.val(this.el.attr("data-default")||"");return this}};$pom.registerControl("textbox",TextBox);var Upload=function(el,pom){Upload.superclass.constructor.call(this,el,pom);this.init=function(){var bind=this,id=this.el.attr("id"),callback=this.el.attr("data-callback");var submit=function(e,t){t.formData={"ajax-method":callback,"ajax-args[]":id,"ajax-key":$(document.body).attr("id"),"ajax-vs":JSON.stringify(bind.pom.getVS())}};var always=function(e,t){bind.el=$("#"+id)};Upload.superclass.init.call(this);var ops=eval("("+(this.el.attr("data-settings")||"{}")+")");ops.dataType="json";ops.paramName=id+(this.el.attr("multiple")=="multiple"?"[]":"");ops.multipart=true;this.el.fileupload(ops).off("fileuploadsubmit",submit).off("fileuploadalways",always).on("fileuploadalways",always);if(callback)this.el.on("fileuploadsubmit",submit);return this};this.remove=function(){this.el.fileupload("destroy");Upload.superclass.remove.call(this);return this};this.value=function(){return""}};$pom.registerControl("upload",Upload);var CheckBox=function(e,t){CheckBox.superclass.constructor.call(this,e,t);this.vs=function(){var e=CheckBox.superclass.vs.call(this);e["attrs"]["checked"]=this.el.prop("checked")?"checked":"";return e};this.validate=function(e){if(e.type()=="vrequired")return e.check(this.el.prop("checked"));return true};this.clean=function(){this.el.prop("checked",false);return this}};$pom.registerControl("checkbox",CheckBox);var Radio=function(e,t){Radio.superclass.constructor.call(this,e,t);this.vs=function(){var e=Radio.superclass.vs.call(this);e["attrs"]["checked"]=this.el.prop("checked")?"checked":"";return e};this.validate=function(e){if(e.type()=="vrequired")return e.check(this.el.prop("checked"));return true};this.clean=function(){this.el.prop("checked",false);return this}};$pom.registerControl("radio",Radio);var Button=function(e,t){Button.superclass.constructor.call(this,e,t)};$pom.registerControl("button",Button);var Image=function(e,t){Image.superclass.constructor.call(this,e,t)};$pom.registerControl("image",Image);var Autofill=function(e,t){Autofill.superclass.constructor.call(this,e,t);var n,r,i,s=e.attr("id");var o=function(){$("#list-"+s).hide();$(document.body).off("click",o)};this.addEvent(s+"_af_e1","keyup",function(t){if(t.keyCode==13||t.keyCode==9||t.keyCode>=37&&t.keyCode<=40)return false;if(r)clearTimeout(r);r=setTimeout(function(){var e=$("#"+s),r=$("#list-"+s),u=e.attr("data-callback")||"@"+s+"->search";r.hide();if(i)i.abort();i=$ajax.setup({global:false},true).doit(e.attr("data-callback"),t.currentTarget.value).done(function(t){if(t!=""){var s=e.offset(),u=parseInt(r.css("width"));r.html(t);r.css({position:"absolute",display:"block",width:u?u:e.width()});r.offset({left:s.left,top:s.top+e.outerHeight()});r.scrollTop(0);$(document.body).click(o)}else r.hide();i=null;n=-1})},e.attr("data-timeout")||0)});this.addEvent(s+"_af_e2","keydown",function(e){if(i||e.keyCode!=13&&e.keyCode!=38&&e.keyCode!=40)return;var t=$("#"+s),r=$("#list-"+s);if(e.keyCode==13){if(r.css("display")!="none")$("#list-"+s+" li:eq("+n+")").click()}else{var o=t.attr("data-activeitemclass"),u=$("#list-"+s+" li").removeClass(o).length;if(u==0)return;if(r.css("display")=="none")r.show();n+=e.keyCode-39;if(n<0)n=u-1;else if(n>=u)n=0;var a=$("#list-"+s+" li:eq("+n+")").addClass(o);r.scrollTop(a[0].offsetTop-(r.height()-a.height())/2)}});this.addEvent(s+"_af_e3","blur",function(e){if(i)i.abort()})};$pom.registerControl("autofill",Autofill,TextBox);var CKEditor=function(el,pom){CKEditor.superclass.constructor.call(this,el,pom);this.vs=function(){return CKEditor.superclass.vs.call(this,["style","class"])};this.init=function(){CKEditor.superclass.init.call(this);if(this.editor)this.editor.destroy();this.editor=CKEDITOR.replace(el.attr("id"),eval("("+(this.el.attr("data-settings")||"{}")+")"));return this};this.remove=function(){if(this.editor)this.editor.destroy();CKEditor.superclass.remove.call(this);return this};this.focus=function(){this.editor.focus();return this};this.value=function(){if(this.editor)return this.editor.getData();return CKEditor.superclass.value.call(this)};this.validate=function(e){return e.check(this.value())};this.clean=function(){CKEDITOR.instances[this.el.attr("id")].setData("");return this}};$pom.registerControl("ckeditor",CKEditor);var DropDownBox=function(e,t){DropDownBox.superclass.constructor.call(this,e,t);this.validate=function(e){var t=this.value();if($.isArray(t))t=t.join("");return e.check(t)}};$pom.registerControl("dropdownbox",DropDownBox);var Paginator=function(e,t){Paginator.superclass.constructor.call(this,e,t)};$pom.registerControl("paginator",Paginator);var ColorPicker=function(el,pom){ColorPicker.superclass.constructor.call(this,el,pom);this.init=function(){ColorPicker.superclass.init.call(this);this.el.spectrum(eval("("+(this.el.attr("data-settings")||"{}")+")"));return this};this.refresh=function(e,t){this.el.spectrum("destroy");ColorPicker.superclass.refresh.call(this,e,t);return this};this.remove=function(){this.el.spectrum("destroy");ColorPicker.superclass.remove.call(this);return this};this.validate=function(e){return e.check(this.value())}};$pom.registerControl("colorpicker",ColorPicker);var DateTimePicker=function(el,pom){DateTimePicker.superclass.constructor.call(this,el,pom);this.init=function(){DateTimePicker.superclass.init.call(this);this.el.datetimepicker("destroy").datetimepicker(eval("("+(this.el.attr("data-settings")||"{}")+")"));return this};this.remove=function(){this.el.datetimepicker("destroy");DateTimePicker.superclass.remove.call(this);return this};this.validate=function(e){return e.check(this.value())}};$pom.registerControl("datetimepicker",DateTimePicker);var Slider=function(el,pom){Slider.superclass.constructor.call(this,el,pom);this.init=function(){Slider.superclass.init.call(this);this.el.noUiSlider(eval("("+(this.el.attr("data-settings")||"{}")+")"),this.el.html()?true:false);return this}};$pom.registerControl("slider",Slider);var HyperLink=function(e,t){HyperLink.superclass.constructor.call(this,e,t)};$pom.registerControl("hyperlink",HyperLink);var Panel=function(e,t){Panel.superclass.constructor.call(this,e,t);this.get=function(e){return this.pom.get(e,this.el)};this.has=function(e){if(e instanceof Control)e=e.el.attr("id");var t=this.get(e);return t!==false&&t!==this};this.getControls=function(e){var t,n=[],r=this;if(e){$("[data-ctrl]",this.el).each(function(){t=r.pom.get(this.id);if(t)n.push(t)})}else{var i,s=[];$("[data-ctrl]",this.el).each(function(){t=r.pom.get(this.id);if(t){i=true;for(var e in s){if(s[e].has(t)){i=false;break}}if(i){if(t instanceof Panel)s.push(t);n.push(t)}}})}return n};this.clean=function(e){$.each(this.getControls(e),function(e,t){t.clean()});return this};this.check=function(e,t){$.each(this.getControls(t),function(t,n){if(n instanceof CheckBox)n.el.prop("checked",e)});return this};this.refresh=function(e,t){Panel.superclass.refresh.call(this,e,t);if(typeof e!="object"){$.each(this.getControls(true),function(e,t){t.init()})}return this.init()}};$pom.registerControl("panel",Panel);var Grid=function(e,t){Grid.superclass.constructor.call(this,e,t)};$pom.registerControl("grid",Grid,Panel);var visiblePopupIdentifiers=[];var Popup=function(e,t){Popup.superclass.constructor.call(this,e,t);var n=this,r=e.attr("id");var i=function(e){e.stopPropagation()};var s=function(e){var t=visiblePopupIdentifiers.pop();if(r!=t)visiblePopupIdentifiers.push(t);else{n.hide();e.stopPropagation()}};var o=function(e){if(e.which==27){var t=visiblePopupIdentifiers.pop();if(r!=t)visiblePopupIdentifiers.push(t);else{n.hide();e.stopPropagation()}}};this.show=function(e){var t=$.inArray(r,visiblePopupIdentifiers);if(t>-1)delete visiblePopupIdentifiers[t];var n=visiblePopupIdentifiers.pop();if(n){this.el.css("z-index",$("#"+n).css("z-index")+1e3);visiblePopupIdentifiers.push(n)}visiblePopupIdentifiers.push(r);if(this.el.attr("data-overlay")){var u,a=this.el.attr("data-overlayselector");if(a)u=$(a);else{u=$("#overlay_"+r);if(u.length==0){var f=this.el.attr("data-overlayclass");u=$(document.createElement("div"));u.attr("id","overlay_"+r);if(f)u.addClass(f);else u.css({position:"fixed",left:0,top:0,width:"100%",height:"100%",backgroundColor:"#000000",opacity:.5});$(document.body).append(u)}}if(u){u.css("z-index",this.el.css("z-index")-1);u.show()}}if(this.el.attr("data-closebydocument")){$(this.el).off("click",i).click(i);$(document.body).off("click",s).click(s)}if(this.el.attr("data-closebyescape")){$(document.body).off("keyup",o).keyup(o)}var l=this.el.attr("data-closebuttons");if(l)$(l).off("click",s).click(s);var c=this.el.css("position");if(c!="fixed"&&c!="absolute"){this.el.css("position","fixed");c="fixed"}if(e){this.el.css({top:($(window).height()-this.el.outerHeight())/2+(c!="fixed"?$(window).scrollTop():0)+"px",left:($(window).width()-this.el.outerWidth())/2+(c!="fixed"?$(window).scrollLeft():0)+"px"})}this.el.show();return this};this.hide=function(){this.el.hide();if(this.el.attr("data-overlay")){var e=$(this.el.attr("data-overlayselector")||"#overlay_"+this.el.attr("id"));if(e)e.hide()}if(this.el.attr("data-closebydocument")){$(document.body).off("click",s);$(this.el).off("click",i)}if(this.el.attr("data-closebyescape")){$(document.body).off("keyup",o)}if(this.el.attr("data-closebuttons"))$(this.el.attr("data-closebuttons")).off("click",s);var t=$.inArray(r,visiblePopupIdentifiers);if(t>-1)delete visiblePopupIdentifiers[t];return this};this.remove=function(){this.hide();Popup.superclass.remove.call(this);return this}};$pom.registerControl("popup",Popup,Panel);var ImgEditor=function(e,t){ImgEditor.superclass.constructor.call(this,e,t);var n=this,r=e.attr("id"),i,s,o;var u={scale:100,angle:0,cropEnabled:true,cropResizable:false,cropWidth:50,cropHeight:50,cropMinWidth:10,cropMinHeight:10,cropMaxWidth:0,cropMaxHeight:0};var a=function(){if(!i)return;var e=$("#canvas_"+r),t=$("#crop_"+r);var n=e.width(),s=e.height();if(t.width()>n){i.cropWidth=n;t.width(n)}if(t.height()>s){i.cropHeight=s;t.height(s)}var o=t.position(),u=o.left+i.cropWidth,a=o.top+i.cropHeight;if(u>n)o.left=n-i.cropWidth;if(a>s)o.top=s-i.cropHeight;h(o.left,o.top)};var f=function(){c(o.attrs.x,o.attrs.y,$(this).val(),i.scale)};var l=function(){c(o.attrs.x,o.attrs.y,i.angle,$(this).val())};var c=function(e,t,n,r){o.transform("");o.attr({x:e,y:t});i.angle=n;o.rotate(n);i.scale=r;r/=100;o.scale(r,r)};var h=function(e,t){$("#crop_"+r).css({left:e,top:t,width:i.cropWidth,height:i.cropHeight});$("#cropLineLeft_"+r).css({left:e,top:t,width:1,height:i.cropHeight});$("#cropLineRight_"+r).css({left:e+i.cropWidth,top:t,width:1,height:i.cropHeight});$("#cropLineTop_"+r).css({left:e,top:t,width:i.cropWidth,height:1});$("#cropLineBottom_"+r).css({left:e,top:t+i.cropHeight,width:i.cropWidth,height:1});$("#shadowTop_"+r).css({left:0,top:0,right:0,height:t});$("#shadowBottom_"+r).css({left:0,top:t+i.cropHeight,right:0,bottom:0});$("#shadowLeft_"+r).css({left:0,top:t,width:e,height:i.cropHeight});$("#shadowRight_"+r).css({left:e+i.cropWidth,top:t,right:0,height:i.cropHeight});if(i.cropResizable){$("#cropSnapNW_"+r).css({left:e,top:t});$("#cropSnapN_"+r).css({left:e+i.cropWidth/2,top:t});$("#cropSnapNE_"+r).css({left:e+i.cropWidth,top:t});$("#cropSnapW_"+r).css({left:e,top:t+i.cropHeight/2});$("#cropSnapE_"+r).css({left:e+i.cropWidth,top:t+i.cropHeight/2});$("#cropSnapSW_"+r).css({left:e,top:t+i.cropHeight});$("#cropSnapS_"+r).css({left:e+i.cropWidth/2,top:t+i.cropHeight});$("#cropSnapSE_"+r).css({left:e+i.cropWidth,top:t+i.cropHeight})}$("#width_"+r).text(i.cropWidth);$("#height_"+r).text(i.cropHeight)};var p=function(){var e=$("#crop_"+r),t=$("#canvas_"+r);if(i.cropEnabled){e.off().on("mousedown",function(e){var n=t.width(),r=t.height();var s=$(this).position(),o={left:e.pageX-s.left,top:e.pageY-s.top};$(document).on("mousemove",function(e){var t=e.pageX-o.left,s=e.pageY-o.top;if(t<0)t=0;if(s<0)s=0;if(t>n-i.cropWidth-1)t=n-i.cropWidth-1;if(s>r-i.cropHeight-1)s=r-i.cropHeight-1;h(t,s);e.preventDefault()}).on("mouseup",function(e){$(this).off("mousemove")});e.preventDefault();e.stopPropagation()});if(i.cropResizable){$(".crop-snap","#"+r).off().show().on("mousedown",function(n){var s=t.width(),o=t.height();var u=$(this),a=u.position(),f={left:n.pageX-a.left,top:n.pageY-a.top};var l=u.attr("id").substr(8,u.attr("id").length-r.length-9);var c=i.cropMinWidth,p=i.cropMinHeight;var d=i.cropMaxWidth<1||i.cropMaxWidth>s?s-1:i.cropMaxWidth;var v=i.cropMaxHeight<1||i.cropMaxHeight>o?o-1:i.cropMaxHeight;$(document).on("mousemove",function(t){var n=t.pageX-f.left,r=t.pageY-f.top;var u=e.position(),a={left:u.left,top:u.top,width:e.width(),height:e.height()};a.right=a.left+a.width;a.bottom=a.top+a.height;switch(l){case"N":if(a.bottom-r>v)r=a.bottom-v;if(a.bottom-r<p)r=a.bottom-p;i.cropHeight=a.bottom-r;a.top=r;break;case"S":if(r-a.top>v)r=a.top+v;if(r-a.top<p)r=a.top+p;i.cropHeight=r-a.top;break;case"W":if(a.right-n>d)n=a.right-d;if(a.right-n<c)n=a.right-c;i.cropWidth=a.right-n;a.left=n;break;case"E":if(n-a.left>d)n=a.left+d;if(n-a.left<c)n=a.left+c;i.cropWidth=n-a.left;break;case"NW":if(a.bottom-r>v)r=a.bottom-v;if(a.bottom-r<p)r=a.bottom-p;if(a.right-n>d)n=a.right-d;if(a.right-n<c)n=a.right-c;i.cropHeight=a.bottom-r;i.cropWidth=a.right-n;a.top=r;a.left=n;break;case"NE":if(a.bottom-r>v)r=a.bottom-v;if(a.bottom-r<p)r=a.bottom-p;if(n-a.left>d)n=a.left+d;if(n-a.left<c)n=a.left+c;i.cropHeight=a.bottom-r;i.cropWidth=n-a.left;a.top=r;break;case"SW":if(r-a.top>v)r=a.top+v;if(r-a.top<p)r=a.top+p;if(a.right-n>d)n=a.right-d;if(a.right-n<c)n=a.right-c;i.cropHeight=r-a.top;i.cropWidth=a.right-n;a.left=n;break;case"SE":if(r-a.top>v)r=a.top+v;if(r-a.top<p)r=a.top+p;if(n-a.left>d)n=a.left+d;if(n-a.left<c)n=a.left+c;i.cropHeight=r-a.top;i.cropWidth=n-a.left;break}if(a.left<0)a.left=0;if(a.top<0)a.top=0;if(a.left>s-i.cropWidth-1)a.left=s-i.cropWidth-1;if(a.top>o-i.cropHeight-1)a.top=o-i.cropHeight-1;h(a.left,a.top);t.preventDefault()}).on("mouseup",function(e){$(this).off("mousemove")});n.preventDefault();n.stopPropagation()})}e.show();$(".shadow, .crop-line","#"+r).show();h((t.width()-i.cropWidth)/2,(t.height()-i.cropHeight)/2)}else{e.off().hide();$(".shadow, .crop-line, .crop-snap","#"+r).off().hide()}t.off().on("mousedown",function(e){var t=$(document.body).css("cursor");$(document.body).css("cursor","move");var n=e.pageX-o.attrs.x,r=e.pageY-o.attrs.y;$(document).on("mousemove",function(e){c(e.pageX-n,e.pageY-r,i.angle,i.scale);e.preventDefault()}).on("mouseup",function(){$(this).off("mousemove");$(document.body).css("cursor",t)});e.preventDefault();e.stopPropagation()})};var d=function(e){if(e.data.useOriginal){n.hide();$ajax.doit(i.callback,i.UID)}else{var t=n.getTransformData();n.hide();$ajax.doit(i.callback,i.UID,t)}};$(window).resize(a);this.init=function(){Popup.superclass.init.call(this);if(s)s.remove();s=new Raphael("canvas_"+r);return this};this.load=function(e,t,n,a){i=$.extend({},u,a);s.clear();this.show(true);s.setSize("100%","100%");o=s.image(e,0,0,t,n);var h=$("#canvas_"+r),v=h.width(),m=h.height();if(i.cropEnabled){if(i.cropMinWidth<1)i.cropMinWidth=1;if(i.cropMinHeight<1)i.cropMinHeight=1;if(i.cropWidth<1)i.cropWidth=1;if(i.cropHeight<1)i.cropHeight=1;if(i.cropWidth>v)i.cropWidth=v;if(i.cropHeight>m)i.cropHeight=m}else{$("#width_"+r).text(t);$("#height_"+r).text(n)}c((v-o.attrs.width)/2,(m-o.attrs.height)/2,i.angle,i.scale);this.get("rotate").el.off().on("slide",f).on("set",f).val(i.angle);this.get("zoom").el.off().on("slide",l).on("set",l).val(i.scale);this.get("btnApply").el.off("click",d).on("click",{useOriginal:false},d);this.get("btnUseOriginal").el.off("click",d).on("click",{useOriginal:true},d);p();return this};this.getTransformData=function(){if(!o)return[];var e={};if(i.cropEnabled){var t=o.getBBox(),n=$("#crop_"+r),s=n.position();e.cropLeft=s.left-t.x;e.cropTop=s.top-t.y;e.cropWidth=n.width();e.cropHeight=n.height()}e.angle=-i.angle;e.scale=i.scale/100;e.bgcolor=this.get("bgcolor").value();e.isSmartCrop=this.get("smartCrop").el.prop("checked")?1:0;return e};this.remove=function(){$(window).off("resize",a);this.hide();Popup.superclass.remove.call(this);return this}};$pom.registerControl("imgeditor",ImgEditor,Popup);var Validator=function(e,t){Validator.superclass.constructor.call(this,e,t);this.result={};this.setState=function(e){if(this.el.attr("data-hiding")==1){if(e)this.el.hide();else this.el.show()}else{if(e)this.el.html("");else this.el.html(this.el.attr("data-text"))}this.el.attr("data-state",e?"1":"");this.el.trigger(e?"valid":"invalid",[this]);return this};this.getState=function(){return this.el.attr("data-state")=="1"};this.getControls=function(){var e=this.el.attr("data-controls");if(!e)return[];return e.split(/\s*,\s*/)};this.getGroups=function(){return(this.el.attr("data-groups")||"default").split(/\s*,\s*/)};this.getMode=function(){return(this.el.attr("data-mode")||"AND").toUpperCase()};this.getIndex=function(){return parseInt(this.el.attr("data-index"))||0};this.hasGroup=function(e){var t=this.getGroups();if(!$.isArray(e))return $.inArray(e,t);for(var n=0;n<e.length;n++)if($.inArray(e[n],t)!=-1)return true;return false};this.lock=function(e){if(e)this.el.attr("data-locked",1);else this.el.removeAttr("data-locked");return this};this.isLocked=function(){return this.el.attr("data-locked")};this.clean=function(){return this.setState(true)};this.validate=function(){this.result={};var e=this.getControls();if(e.length==0){this.setState(true);return true}var t,n,r;switch(this.getMode()){default:case"AND":n=true;for(t=0;t<e.length;t++){r=this.pom.get(e[t]);if(!r)throw new Error("Control with ID = "+e[t]+" is not found.");if(r.validate(this))this.result[r.el.attr("id")]=true;else this.result[r.el.attr("id")]=n=false}break;case"OR":n=false;for(t=0;t<e.length;t++){r=this.pom.get(e[t]);if(!r)throw new Error("Control with ID = "+e[t]+" is not found.");if(r.validate(this))this.result[r.el.attr("id")]=n=true;else this.result[r.el.attr("id")]=false}break;case"XOR":var i=0;for(t=0;t<e.length;t++){r=this.pom.get(e[t]);if(!r)throw new Error("Control with ID = "+e[t]+" is not found.");if(r.validate(this)){this.result[r.el.attr("id")]=i<1;i++}else this.result[r.el.attr("id")]=false}n=i==1;break}this.setState(n);return n};this.refresh=function(e,t){Validator.superclass.refresh.call(this,e,t);return this.setState(this.el.attr("data-state")=="1")}};$pom.registerControl("validator",Validator);var VRequired=function(e,t){VRequired.superclass.constructor.call(this,e,t);this.check=function(e){if(e===false||e===true)return e;if(this.el.attr("data-trim"))return $.trim(e)!="";return e!=""}};$pom.registerValidator("vrequired",VRequired);var VRegExp=function(el,pom){VRegExp.superclass.constructor.call(this,el,pom);this.check=function(value){var flag,exp=this.el.attr("data-expression");if(exp==""||this.el.attr("data-empty")=="1"&&value=="")return true;if(exp.charAt(0)=="i")eval("flag = !"+exp.substr(1)+".test(value);");else eval("flag = "+exp+".test(value);");return flag}};$pom.registerValidator("vregexp",VRegExp);var VEmail=function(e,t){VEmail.superclass.constructor.call(this,e,t)};$pom.registerValidator("vemail",VRegExp);var VCompare=function(e,t){VCompare.superclass.constructor.call(this,e,t);this.validate=function(e){var t=this.getControls();this.result={};if(t.length==0){this.setState(true);return true}var n,r,i,s,o,u,a;switch(this.getMode()){default:case"AND":i=true;for(n=0;n<t.length-1;n++){u=this.pom.get(t[n]);if(!u)throw new Error("Control with ID = "+t[n]+" is not found.");s=u.validate(this);for(r=n+1;r<t.length;r++){a=this.pom.get(t[r]);if(!a)throw new Error("Control with ID = "+t[r]+" is not found.");o=a.validate(this);if(s===o)this.result[t[n]]=this.result[t[r]]=true;else this.result[t[n]]=this.result[t[r]]=i=false}}break;case"OR":i=false;for(n=0;n<t.length-1;n++){u=this.pom.get(t[n]);if(!u)throw new Error("Control with ID = "+t[n]+" is not found.");s=u.validate(this);for(r=n+1;r<t.length;r++){a=this.pom.get(t[r]);if(!a)throw new Error("Control with ID = "+t[r]+" is not found.");o=a.validate(this);if(s===o)this.result[t[n]]=this.result[t[r]]=i=true;else this.result[t[n]]=this.result[t[r]]=false}}break;case"XOR":var f=0;for(n=0;n<t.length-1;n++){u=this.pom.get(t[n]);if(!u)throw new Error("Control with ID = "+t[n]+" is not found.");s=u.validate(this);for(r=n+1;r<t.length;r++){a=this.pom.get(t[r]);if(!a)throw new Error("Control with ID = "+t[r]+" is not found.");o=a.validate(this);if(s===o){this.result[t[n]]=this.result[t[r]]=f<1;f++}else this.result[t[n]]=this.result[t[r]]=false}}i=f==1;break}this.setState(i);return i};this.check=function(e){return this.el.attr("data-caseinsensitive")=="1"?(e+"").toLowerCase():e}};$pom.registerValidator("vcompare",VCompare);var VCustom=function(e,t){VCustom.superclass.constructor.call(this,e,t);this.validate=function(){var e,t=this.el.attr("data-clientfunction");if(t){e=window[t](this);this.setState(e);return e}var n=this.getControls();e=this.el.attr("data-serverfunction")?this.el.attr("data-state")=="1":true;for(var r=0;r<n.length;r++)this.result[n[r]]=e;this.setState(e);return true}};$pom.registerValidator("vcustom",VCustom)