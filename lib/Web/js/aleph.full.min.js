/*! Aleph v1.0.0 | (c) 2014 Aleph Tav <4lephtav@gmail.com> | http://www.opensource.org/licenses/MIT */
var CONTAINER_PREFIX="cont-",Control=function(t){var e=function(t,e){this.el=t,this.pom=e,this.events={}},i=function(t,e,i,r){var o,s,a=t.get(0).attributes;for(o=a.length-1;o>=0;o--)s=a[o].name,r.indexOf(s)<0&&(e[i+("data-"==s.substr(0,5)?s.substr(5):s)]=t.attr(s))};return e.prototype.vs=function(e){e=e||[],e.push("id"),e.push("data-ctrl");var r={attrs:{}};this.el.get(0).value!=t&&(r.value=this.value()),i(this.el,r.attrs,"",e);var o=$("#"+CONTAINER_PREFIX+this.el.attr("id"));return o.length&&i(o,r.attrs,CONTAINER_PREFIX,e),r},e.prototype.container=function(){var t=$("#"+CONTAINER_PREFIX+this.el.attr("id"));return t.length?t:this.el},e.prototype.type=function(){return this.el.attr("data-ctrl")},e.prototype.value=function(){return this.el.val()},e.prototype.clean=function(){return this.el.val(""),this},e.prototype.focus=function(){return this.el.focus(),this},e.prototype.validate=function(){return!0},e.prototype.init=function(){return this.el=$("#"+this.el.attr("id")),this.refreshEvents()},e.prototype.refreshAttributes=function(t,e){var i=this.container(),r=CONTAINER_PREFIX.length;for(var o in e)o=e[o],o.substr(0,r)!=CONTAINER_PREFIX?this.el.removeAttr(o):i.removeAttr(o.substr(r));var s;for(var o in t)s=t[o],o.substr(0,r)!=CONTAINER_PREFIX?("checked"==o&&this.el.prop(o,s),this.el.attr(o,s)):("checked"==o&&i.prop(o.substr(r),s),i.attr(o.substr(r),s));return this},e.prototype.refresh=function(t,e){if("object"==typeof t)this.refreshAttributes(t,e);else{var i=this.el.attr("id");this.container().replaceWith(t),this.el=$("#"+i)}return this.init()},e.prototype.remove=function(){return this.removeEvents(!0),this.container().remove(),this},e.prototype.bind=function(e,i,r,o,s,a){if(this.unbind(e),this.addEvent(e,i,r,o,s,a),!o||o()){var n=s?$("#"+CONTAINER_PREFIX+this.el.attr("id")):this.el;a!=t?n.on(i,a,r):n.on(i,r)}return this},e.prototype.unbind=function(t){return this.removeEvent(t),delete this.events[t],this},e.prototype.addEvent=function(t,e,i,r,o,s){return this.events[t]={type:e,callback:i,check:r,toContainer:o,data:s},this},e.prototype.removeEvent=function(e){var i=this.events[e];return i!=t&&(i.toContainer?$("#"+CONTAINER_PREFIX+this.el.attr("id")):this.el).off(i.type,i.callback),this},e.prototype.removeEvents=function(t){return this.el.off(),$("#"+CONTAINER_PREFIX+this.el.attr("id")).off(),t&&(this.events={}),this},e.prototype.restoreEvents=function(){var e,i,r=$("#"+CONTAINER_PREFIX+this.el.attr("id"));for(var o in this.events)e=this.events[o],(!e.check||e.check())&&(i=e.toContainer?r:this.el,e.data!=t?i.on(e.type,e.data,e.callback):i.on(e.type,e.callback));return this},e.prototype.refreshEvents=function(){return this.removeEvents().restoreEvents()},e}(),POM=function(t){var e={},i={},r={},o=function(t,e){var i=function(){};return i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t,t.superclass=e.prototype,t},s=function(){};return s.prototype.registerControl=function(t,e,r){return i[t]=o(e,r||Control)},s.prototype.registerValidator=function(t,e,r){return i[t]=o(e,r||Validator)},s.prototype.get=function(e,o){if(!o&&r[e])return r[e];var s=$("#"+e,o);if(0==s.length){if(!o)for(var a in r)if(r[a].el.attr("data-fullid").substr(-e.length)==e)return r[a];if(s=$("[data-fullid$='"+e+"'][data-ctrl]",o),0==s.length)return o||delete r[e],!1;s=$(s.get(0))}if(e=s.attr("id"),""==e)return!1;if(r[e])return r[e];var n=s.attr("data-ctrl").toLowerCase();return i[n]==t?!1:r[e]=new i[n](s,this).init()},s.prototype.setVS=function(){e={};var t=this;return $("[data-ctrl]").each(function(){var i=t.get(this.id);i&&(e[this.id]=i.vs())}),this},s.prototype.getVS=function(){var i={},r=this;return $("[data-ctrl]").each(function(o,s){var a=r.get(s.id).vs();if("undefined"==typeof e[s.id])i[s.id]=a;else{i[s.id]={};for(var n in a.attrs)JSON.stringify(e[s.id].attrs[n])!==JSON.stringify(a.attrs[n])&&(i[s.id].attrs==t&&(i[s.id].attrs={}),i[s.id].attrs[n]=a.attrs[n]);for(var n in e[s.id].attrs)a.attrs[n]==t&&(i[s.id].removed==t&&(i[s.id].removed=[]),i[s.id].removed.push(n));JSON.stringify(e[s.id].value)!==JSON.stringify(a.value)&&(i[s.id].value=a.value),i[s.id].attrs==t&&i[s.id].removed==t&&i[s.id].value==t&&delete i[s.id]}}),{ts:(new Date).valueOf(),vs:i}},s.prototype._refreshPOMTree=function(t){var i,o,s;s=t.created;for(i in s)o=this.get(i),o&&(o.remove(),delete r[i],delete t.removed[i]);for(i in s){var a=s[i].mode,n=s[i].id,l=s[i].html;if(a&&n){switch(o=$("#"+CONTAINER_PREFIX+n).length&&$("[id='"+n+"'][data-ctrl]").length?"#"+CONTAINER_PREFIX+n:"#"+n,a){case"top":$(o).prepend(l);break;case"bottom":$(o).append(l);break;case"before":$(o).before(l);break;case"after":$(o).after(l);break;case"replace":delete r[n],delete e[n],$(o).replaceWith(l)}o=$("#"+CONTAINER_PREFIX+i).length&&$("[id='"+i+"'][data-ctrl]").length?"#"+CONTAINER_PREFIX+i:"#"+i,$("[data-ctrl]",o).each(function(){delete r[this.id]})}}s=t.removed;for(i in s)o=this.get(i),o&&(o.remove(),delete r[i]);s=t.refreshed;var c,h={};for(i in s)if(o=this.get(i)){if(o.getControls&&"object"!=typeof s[i]){for(c in h)o.has(h[c])&&delete h[c];h[i]=o}}else delete s[i];for(i in s){o=this.get(i);for(c in h)if(h[c].has(o)){delete s[i];break}}for(i in s)o=this.get(i),"object"==typeof s[i]?o.refresh(s[i].attrs,s[i].removed):o.refresh(s[i]);return this},s.prototype.getValidators=function(t){var e=[],i=this;return"*"==t?$("[data-groups][data-controls]").each(function(){var t=i.get($(this).attr("id"));t&&!t.isLocked()&&e.push(t)}):(t=(t||"default").split(/\s*,\s*/),$("[data-groups][data-controls]").each(function(){var r=i.get($(this).attr("id"));r&&!r.isLocked()&&r.hasGroup(t)&&e.push(r)})),e},s.prototype.validate=function(e,i,r){var o=this.getValidators(e);o.sort(function(t,e){return t.getIndex()-e.getIndex()});var s,a,n,l,c,h,p,u=!0,d={};for(s=0;s<o.length;s++)if(l=o[s],l.validate())for(a in l.result)d[a]==t&&(d[a]=!0);else{u=!1;for(var a in l.result)l.result[a]?d[a]==t&&(d[a]=!0):d[a]=!1}for(a in d)n=$("#"+CONTAINER_PREFIX+a),n=n.length>0?n:$("#"+a),d[a]?n.removeClass(i).addClass(r):("none"==n.css("display")?(h=n.show().offset(),n.hide()):h=n.offset(),n.removeClass(r).addClass(i),(!c||p.top>h.top||p.top==h.top&&p.left>h.left)&&(c=n,p=h));return c&&(n=this.get(c.attr("id")),n?n.focus():c.focus()),u},s.prototype.reset=function(t,e,i){var r,o=this.getValidators(t);return $.each(o,function(t,o){for(var s=o.getControls(),a=0;a<s.length;a++)r=$("#"+CONTAINER_PREFIX+s[a]),r=r.length>0?r:$("#"+s[a]),r.removeClass(e).addClass(i);o.setState(!0)}),this},s}(),$pom=new POM;$(function(){$pom.setVS()});var Ajax=function(){var t,e,i={},r=function(){e=document.body.style.cursor,document.body.style.cursor="wait"},o=function(){document.body.style.cursor=e},s=function(t){this.pom=t,this.setup({global:!0,type:"POST",url:window.location.href,ajaxStart:r,ajaxStop:o,dataFilter:function(t){if("object"==$.type(t)&&(t=$(t[0].body).text()),0==t.length)return"null";var e,i=t.substr(0,13),r=t.lastIndexOf(i);return e=1>r?t:t.substr(13,r-13),e.length&&$.globalEval(e),r>0?t.substr(r+13):"null"}})};return s.prototype.setup=function(e,i){return i?(t=e,this):(e.global&&(e.ajaxStart&&$(document).ajaxStart(e.ajaxStart),e.ajaxStop&&$(document).ajaxStop(e.ajaxStop),e.ajaxComplete&&$(document).ajaxComplete(e.ajaxComplete),e.ajaxError&&$(document).ajaxError(e.ajaxError),e.ajaxSuccess&&$(document).ajaxSuccess(e.ajaxSuccess),e.ajaxSend&&$(document).ajaxSend(e.ajaxSend)),$.ajaxSetup(e),this)},s.prototype.doit=function(e){this.pom.setVS();var i={"ajax-method":e,"ajax-args":Array.prototype.slice.call(arguments,1),"ajax-key":$(document.body).attr("id"),"ajax-vs":this.pom.getVS()},r={data:i};return t&&(r=t,r.data=i,t=null),$.ajax(r)},s.prototype.submit=function(t,e,r,o){return!i[t]&&this.pom.validate(e,r,o)?(i[t]=!0,this.doit.apply(this,$.merge([t],Array.prototype.slice.call(arguments,4))).always(function(){delete i[t]})):!1},s.prototype.action=function(t){var e,i=Array.prototype.slice.call(arguments,1);switch(t=t.toLowerCase()){case"reload":e=0;break;case"alert":case"redirect":case"focus":case"remove":case"script":e=1;break;case"display":case"message":case"inject":e=3;break;default:e=2}e="undefined"==typeof i[e]?0:i[e];var r=function(){switch(t){case"alert":alert(i[0]);break;case"redirect":window.location.assign(i[0]);break;case"reload":window.location.reload(!0);break;case"display":if("undefined"==typeof i[1]&&(i[1]="none"==$(i[0]).css("display")?"":"none"),"undefined"==typeof i[2]||0==i[2])$(i[0]).css("display",i[1]);else{var e=$(i[0]).css("display");$(i[0]).css("display",i[1]),setTimeout(function(){$(i[0]).css("display",e)},i[2])}break;case"message":if("undefined"==typeof i[2]||0==i[2])$(i[0]).html(i[1]);else{var r=$(i[0]).html();$(i[0]).html(i[1]),setTimeout(function(){$(i[0]).html(r)},i[2])}break;case"focus":$(i[0]).focus();break;case"addclass":$(i[0]).addClass(i[1]);break;case"removeclass":$(i[0]).removeClass(i[1]);break;case"toggleclass":$(i[0]).toggleClass(i[1]);break;case"remove":$(i[0]).remove();break;case"insert":$(i[0]).html(i[1]);break;case"replace":$(i[0]).replaceWith(i[1]);break;case"inject":switch(i[2].toLowerCase()){case"top":$(i[0]).prepend(i[1]);break;case"botom":$(i[0]).append(i[1]);break;case"before":$(i[0]).before(i[1]);break;case"after":$(i[0]).after(i[1])}break;case"script":$.globalEval(i[0])}};e>0?setTimeout(r,e):r()},s}(),$ajax=new Ajax($pom),Any=function(t,e){Any.superclass.constructor.call(this,t,e)};$pom.registerControl("any",Any);var Input=function(t,e){Input.superclass.constructor.call(this,t,e),this.validate=function(t){return t.check(this.value())}};$pom.registerControl("input",Input);var Hidden=function(t,e){Hidden.superclass.constructor.call(this,t,e)};$pom.registerControl("hidden",Input);var TextBox=function(t,e){TextBox.superclass.constructor.call(this,t,e);var i=t.attr("id"),r=function(){var t=$(this);t.val()==t.attr("data-default")&&t.val("")},o=function(){var t=$(this);t.val()||t.val(t.attr("data-default"))},s=function(){return!!$("#"+i).attr("data-default")};this.addEvent(i+"_txt_e1","focus",r,s),this.addEvent(i+"_txt_e2","blur",o,s),this.init=function(){TextBox.superclass.init.call(this);var t=this.el.attr("data-default");return t&&(this.el.val()||this.el.val(t)),this},this.refresh=function(t,e){return r.call(this.el),TextBox.superclass.refresh.call(this,t,e)},this.validate=function(t){return t.check(this.value())},this.clean=function(){return this.el.val(this.el.attr("data-default")||""),this}};$pom.registerControl("textbox",TextBox);var Upload=function(el,pom){Upload.superclass.constructor.call(this,el,pom),this.init=function(){var bind=this,id=this.el.attr("id"),callback=this.el.attr("data-callback"),submit=function(t,e){bind.pom.setVS(),e.formData={"ajax-method":callback,"ajax-args[]":id,"ajax-key":$(document.body).attr("id"),"ajax-vs":JSON.stringify(bind.pom.getVS())}},always=function(){bind.el=$("#"+id)};Upload.superclass.init.call(this);var ops=eval("("+(this.el.attr("data-settings")||"{}")+")");return ops.dataType="json",ops.paramName=id+("multiple"==this.el.attr("multiple")?"[]":""),ops.multipart=!0,this.el.fileupload(ops).off("fileuploadsubmit",submit).off("fileuploadalways",always).on("fileuploadalways",always),callback&&this.el.on("fileuploadsubmit",submit),this},this.remove=function(){return this.el.fileupload("destroy"),Upload.superclass.remove.call(this),this},this.value=function(){return""}};$pom.registerControl("upload",Upload);var CheckBox=function(t,e){CheckBox.superclass.constructor.call(this,t,e),this.vs=function(){var t=CheckBox.superclass.vs.call(this);return t.attrs.checked=this.el.prop("checked")?"checked":"",t},this.validate=function(t){return"vrequired"==t.type()?t.check(this.el.prop("checked")):!0},this.clean=function(){return this.el.prop("checked",!1),this}};$pom.registerControl("checkbox",CheckBox);var Radio=function(t,e){Radio.superclass.constructor.call(this,t,e),this.vs=function(){var t=Radio.superclass.vs.call(this);return t.attrs.checked=this.el.prop("checked")?"checked":"",t},this.validate=function(t){return"vrequired"==t.type()?t.check(this.el.prop("checked")):!0},this.clean=function(){return this.el.prop("checked",!1),this}};$pom.registerControl("radio",Radio);var Button=function(t,e){Button.superclass.constructor.call(this,t,e)};$pom.registerControl("button",Button);var Image=function(t,e){Image.superclass.constructor.call(this,t,e)};$pom.registerControl("image",Image);var Autofill=function(t,e){Autofill.superclass.constructor.call(this,t,e);var i,r,o,s=t.attr("id"),a=function(){$("#list-"+s).hide(),$(document.body).off("click",a)};this.addEvent(s+"_af_e1","keyup",function(e){return 13==e.keyCode||9==e.keyCode||e.keyCode>=37&&e.keyCode<=40?!1:(r&&clearTimeout(r),void(r=setTimeout(function(){{var t=$("#"+s),r=$("#list-"+s);t.attr("data-callback")||"@"+s+"->search"}r.hide(),o&&o.abort(),o=$ajax.setup({global:!1},!0).doit(t.attr("data-callback"),e.currentTarget.value).done(function(e){if(""!=e){var s=t.offset(),n=parseInt(r.css("width"));r.html(e),r.css({position:"absolute",display:"block",width:n?n:t.width()}),r.offset({left:s.left,top:s.top+t.outerHeight()}),r.scrollTop(0),$(document.body).click(a)}else r.hide();o=null,i=-1})},t.attr("data-timeout")||0)))}),this.addEvent(s+"_af_e2","keydown",function(t){if(!(o||13!=t.keyCode&&38!=t.keyCode&&40!=t.keyCode)){var e=$("#"+s),r=$("#list-"+s);if(13==t.keyCode)"none"!=r.css("display")&&$("#list-"+s+" li:eq("+i+")").click();else{var a=e.attr("data-activeitemclass"),n=$("#list-"+s+" li").removeClass(a).length;if(0==n)return;"none"==r.css("display")&&r.show(),i+=t.keyCode-39,0>i?i=n-1:i>=n&&(i=0);var l=$("#list-"+s+" li:eq("+i+")").addClass(a);r.scrollTop(l[0].offsetTop-(r.height()-l.height())/2)}}}),this.addEvent(s+"_af_e3","blur",function(){o&&o.abort()})};$pom.registerControl("autofill",Autofill,TextBox);var CKEditor=function(el,pom){CKEditor.superclass.constructor.call(this,el,pom),this.vs=function(){return CKEditor.superclass.vs.call(this,["style","class"])},this.init=function(){return CKEditor.superclass.init.call(this),this.editor&&this.editor.destroy(),this.editor=CKEDITOR.replace(el.attr("id"),eval("("+(this.el.attr("data-settings")||"{}")+")")),this},this.remove=function(){return this.editor&&this.editor.destroy(),CKEditor.superclass.remove.call(this),this},this.focus=function(){return this.editor.focus(),this},this.value=function(){return this.editor?this.editor.getData():CKEditor.superclass.value.call(this)},this.validate=function(t){return t.check(this.value())},this.clean=function(){return CKEDITOR.instances[this.el.attr("id")].setData(""),this}};$pom.registerControl("ckeditor",CKEditor);var DropDownBox=function(t,e){DropDownBox.superclass.constructor.call(this,t,e),this.validate=function(t){var e=this.value();return $.isArray(e)&&(e=e.join("")),t.check(e)}};$pom.registerControl("dropdownbox",DropDownBox);var Paginator=function(t,e){Paginator.superclass.constructor.call(this,t,e)};$pom.registerControl("paginator",Paginator);var ColorPicker=function(el,pom){ColorPicker.superclass.constructor.call(this,el,pom),this.init=function(){return ColorPicker.superclass.init.call(this),this.el.spectrum(eval("("+(this.el.attr("data-settings")||"{}")+")")),this},this.refresh=function(t,e){return this.el.spectrum("destroy"),ColorPicker.superclass.refresh.call(this,t,e),this},this.remove=function(){return this.el.spectrum("destroy"),ColorPicker.superclass.remove.call(this),this},this.validate=function(t){return t.check(this.value())}};$pom.registerControl("colorpicker",ColorPicker);var DateTimePicker=function(el,pom){DateTimePicker.superclass.constructor.call(this,el,pom),this.init=function(){return DateTimePicker.superclass.init.call(this),this.el.datetimepicker("destroy").datetimepicker(eval("("+(this.el.attr("data-settings")||"{}")+")")),this},this.remove=function(){return this.el.datetimepicker("destroy"),DateTimePicker.superclass.remove.call(this),this},this.validate=function(t){return t.check(this.value())}};$pom.registerControl("datetimepicker",DateTimePicker);var Slider=function(el,pom){Slider.superclass.constructor.call(this,el,pom),this.init=function(){return Slider.superclass.init.call(this),this.el.noUiSlider(eval("("+(this.el.attr("data-settings")||"{}")+")"),this.el.html()?!0:!1),this}};$pom.registerControl("slider",Slider);var HyperLink=function(t,e){HyperLink.superclass.constructor.call(this,t,e)};$pom.registerControl("hyperlink",HyperLink);var Panel=function(t,e){Panel.superclass.constructor.call(this,t,e),this.get=function(t){return this.pom.get(t,this.el)},this.has=function(t){t instanceof Control&&(t=t.el.attr("id"));var e=this.get(t);return e!==!1&&e!==this},this.getControls=function(t){var e,i=[],r=this;if(t)$("[data-ctrl]",this.el).each(function(){e=r.pom.get(this.id),e&&i.push(e)});else{var o,s=[];$("[data-ctrl]",this.el).each(function(){if(e=r.pom.get(this.id)){o=!0;for(var t in s)if(s[t].has(e)){o=!1;break}o&&(e instanceof Panel&&s.push(e),i.push(e))}})}return i},this.clean=function(t){return $.each(this.getControls(t),function(t,e){e.clean()}),this},this.check=function(t,e){return $.each(this.getControls(e),function(e,i){i instanceof CheckBox&&i.el.prop("checked",t)}),this},this.refresh=function(t,e){return Panel.superclass.refresh.call(this,t,e),"object"!=typeof t&&$.each(this.getControls(!0),function(t,e){e.init()}),this.init()}};$pom.registerControl("panel",Panel);var Grid=function(t,e){Grid.superclass.constructor.call(this,t,e)};$pom.registerControl("grid",Grid,Panel);var visiblePopupIdentifiers=[],Popup=function(t,e){Popup.superclass.constructor.call(this,t,e);var i=this,r=t.attr("id"),o=function(t){t.stopPropagation()},s=function(t){var e=visiblePopupIdentifiers.pop();r!=e?visiblePopupIdentifiers.push(e):(i.hide(),t.stopPropagation())},a=function(t){if(27==t.which){var e=visiblePopupIdentifiers.pop();r!=e?visiblePopupIdentifiers.push(e):(i.hide(),t.stopPropagation())}};this.show=function(t){var e=$.inArray(r,visiblePopupIdentifiers);e>-1&&delete visiblePopupIdentifiers[e];var i=visiblePopupIdentifiers.pop();if(i&&(this.el.css("z-index",$("#"+i).css("z-index")+1e3),visiblePopupIdentifiers.push(i)),visiblePopupIdentifiers.push(r),this.el.attr("data-overlay")){var n,l=this.el.attr("data-overlayselector");if(l)n=$(l);else if(n=$("#overlay_"+r),0==n.length){var c=this.el.attr("data-overlayclass");n=$(document.createElement("div")),n.attr("id","overlay_"+r),c?n.addClass(c):n.css({position:"fixed",left:0,top:0,width:"100%",height:"100%",backgroundColor:"#000000",opacity:.5}),$(document.body).append(n)}n&&(n.css("z-index",this.el.css("z-index")-1),n.show())}this.el.attr("data-closebydocument")&&($(this.el).off("click",o).click(o),$(document.body).off("click",s).click(s)),this.el.attr("data-closebyescape")&&$(document.body).off("keyup",a).keyup(a);var h=this.el.attr("data-closebuttons");h&&$(h).off("click",s).click(s);var p=this.el.css("position");return"fixed"!=p&&"absolute"!=p&&(this.el.css("position","fixed"),p="fixed"),t&&this.el.css({top:($(window).height()-this.el.outerHeight())/2+("fixed"!=p?$(window).scrollTop():0)+"px",left:($(window).width()-this.el.outerWidth())/2+("fixed"!=p?$(window).scrollLeft():0)+"px"}),this.el.show(),this},this.hide=function(){if(this.el.hide(),this.el.attr("data-overlay")){var t=$(this.el.attr("data-overlayselector")||"#overlay_"+this.el.attr("id"));t&&t.hide()}this.el.attr("data-closebydocument")&&($(document.body).off("click",s),$(this.el).off("click",o)),this.el.attr("data-closebyescape")&&$(document.body).off("keyup",a),this.el.attr("data-closebuttons")&&$(this.el.attr("data-closebuttons")).off("click",s);var e=$.inArray(r,visiblePopupIdentifiers);return e>-1&&delete visiblePopupIdentifiers[e],this},this.remove=function(){return this.hide(),Popup.superclass.remove.call(this),this}};$pom.registerControl("popup",Popup,Panel);var ImgEditor=function(t,e){ImgEditor.superclass.constructor.call(this,t,e);var i,r,o,s=this,a=t.attr("id"),n={scale:100,angle:0,cropEnabled:!0,cropResizable:!1,cropWidth:50,cropHeight:50,cropMinWidth:10,cropMinHeight:10,cropMaxWidth:0,cropMaxHeight:0},l=function(){if(i){var t=$("#canvas_"+a),e=$("#crop_"+a),r=t.width(),o=t.height();e.width()>r&&(i.cropWidth=r,e.width(r)),e.height()>o&&(i.cropHeight=o,e.height(o));var s=e.position(),n=s.left+i.cropWidth,l=s.top+i.cropHeight;n>r&&(s.left=r-i.cropWidth),l>o&&(s.top=o-i.cropHeight),u(s.left,s.top)}},c=function(){p(o.attrs.x,o.attrs.y,$(this).val(),i.scale)},h=function(){p(o.attrs.x,o.attrs.y,i.angle,$(this).val())},p=function(t,e,r,s){o.transform(""),o.attr({x:t,y:e}),i.angle=r,o.rotate(r),i.scale=s,s/=100,o.scale(s,s)},u=function(t,e){$("#crop_"+a).css({left:t,top:e,width:i.cropWidth,height:i.cropHeight}),$("#cropLineLeft_"+a).css({left:t,top:e,width:1,height:i.cropHeight}),$("#cropLineRight_"+a).css({left:t+i.cropWidth,top:e,width:1,height:i.cropHeight}),$("#cropLineTop_"+a).css({left:t,top:e,width:i.cropWidth,height:1}),$("#cropLineBottom_"+a).css({left:t,top:e+i.cropHeight,width:i.cropWidth,height:1}),$("#shadowTop_"+a).css({left:0,top:0,right:0,height:e}),$("#shadowBottom_"+a).css({left:0,top:e+i.cropHeight,right:0,bottom:0}),$("#shadowLeft_"+a).css({left:0,top:e,width:t,height:i.cropHeight}),$("#shadowRight_"+a).css({left:t+i.cropWidth,top:e,right:0,height:i.cropHeight}),i.cropResizable&&($("#cropSnapNW_"+a).css({left:t,top:e}),$("#cropSnapN_"+a).css({left:t+i.cropWidth/2,top:e}),$("#cropSnapNE_"+a).css({left:t+i.cropWidth,top:e}),$("#cropSnapW_"+a).css({left:t,top:e+i.cropHeight/2}),$("#cropSnapE_"+a).css({left:t+i.cropWidth,top:e+i.cropHeight/2}),$("#cropSnapSW_"+a).css({left:t,top:e+i.cropHeight}),$("#cropSnapS_"+a).css({left:t+i.cropWidth/2,top:e+i.cropHeight}),$("#cropSnapSE_"+a).css({left:t+i.cropWidth,top:e+i.cropHeight})),$("#width_"+a).text(i.cropWidth),$("#height_"+a).text(i.cropHeight)},d=function(){var t=$("#crop_"+a),e=$("#canvas_"+a);i.cropEnabled?(t.off().on("mousedown",function(t){var r=e.width(),o=e.height(),s=$(this).position(),a={left:t.pageX-s.left,top:t.pageY-s.top};$(document).on("mousemove",function(t){var e=t.pageX-a.left,s=t.pageY-a.top;0>e&&(e=0),0>s&&(s=0),e>r-i.cropWidth-1&&(e=r-i.cropWidth-1),s>o-i.cropHeight-1&&(s=o-i.cropHeight-1),u(e,s),t.preventDefault()}).on("mouseup",function(){$(this).off("mousemove")}),t.preventDefault(),t.stopPropagation()}),i.cropResizable&&$(".crop-snap","#"+a).off().show().on("mousedown",function(r){var o=e.width(),s=e.height(),n=$(this),l=n.position(),c={left:r.pageX-l.left,top:r.pageY-l.top},h=n.attr("id").substr(8,n.attr("id").length-a.length-9),p=i.cropMinWidth,d=i.cropMinHeight,f=i.cropMaxWidth<1||i.cropMaxWidth>o?o-1:i.cropMaxWidth,v=i.cropMaxHeight<1||i.cropMaxHeight>s?s-1:i.cropMaxHeight;$(document).on("mousemove",function(e){var r=e.pageX-c.left,a=e.pageY-c.top,n=t.position(),l={left:n.left,top:n.top,width:t.width(),height:t.height()};switch(l.right=l.left+l.width,l.bottom=l.top+l.height,h){case"N":l.bottom-a>v&&(a=l.bottom-v),l.bottom-a<d&&(a=l.bottom-d),i.cropHeight=l.bottom-a,l.top=a;break;case"S":a-l.top>v&&(a=l.top+v),a-l.top<d&&(a=l.top+d),i.cropHeight=a-l.top;break;case"W":l.right-r>f&&(r=l.right-f),l.right-r<p&&(r=l.right-p),i.cropWidth=l.right-r,l.left=r;break;case"E":r-l.left>f&&(r=l.left+f),r-l.left<p&&(r=l.left+p),i.cropWidth=r-l.left;break;case"NW":l.bottom-a>v&&(a=l.bottom-v),l.bottom-a<d&&(a=l.bottom-d),l.right-r>f&&(r=l.right-f),l.right-r<p&&(r=l.right-p),i.cropHeight=l.bottom-a,i.cropWidth=l.right-r,l.top=a,l.left=r;break;case"NE":l.bottom-a>v&&(a=l.bottom-v),l.bottom-a<d&&(a=l.bottom-d),r-l.left>f&&(r=l.left+f),r-l.left<p&&(r=l.left+p),i.cropHeight=l.bottom-a,i.cropWidth=r-l.left,l.top=a;break;case"SW":a-l.top>v&&(a=l.top+v),a-l.top<d&&(a=l.top+d),l.right-r>f&&(r=l.right-f),l.right-r<p&&(r=l.right-p),i.cropHeight=a-l.top,i.cropWidth=l.right-r,l.left=r;break;case"SE":a-l.top>v&&(a=l.top+v),a-l.top<d&&(a=l.top+d),r-l.left>f&&(r=l.left+f),r-l.left<p&&(r=l.left+p),i.cropHeight=a-l.top,i.cropWidth=r-l.left}l.left<0&&(l.left=0),l.top<0&&(l.top=0),l.left>o-i.cropWidth-1&&(l.left=o-i.cropWidth-1),l.top>s-i.cropHeight-1&&(l.top=s-i.cropHeight-1),u(l.left,l.top),e.preventDefault()}).on("mouseup",function(){$(this).off("mousemove")}),r.preventDefault(),r.stopPropagation()}),t.show(),$(".shadow, .crop-line","#"+a).show(),u((e.width()-i.cropWidth)/2,(e.height()-i.cropHeight)/2)):(t.off().hide(),$(".shadow, .crop-line, .crop-snap","#"+a).off().hide()),e.off().on("mousedown",function(t){var e=$(document.body).css("cursor");$(document.body).css("cursor","move");var r=t.pageX-o.attrs.x,s=t.pageY-o.attrs.y;$(document).on("mousemove",function(t){p(t.pageX-r,t.pageY-s,i.angle,i.scale),t.preventDefault()}).on("mouseup",function(){$(this).off("mousemove"),$(document.body).css("cursor",e)}),t.preventDefault(),t.stopPropagation()})},f=function(t){if(t.data.useOriginal)s.hide(),$ajax.doit(i.callback,i.UID);else{var e=s.getTransformData();s.hide(),$ajax.doit(i.callback,i.UID,e)}};$(window).resize(l),this.init=function(){return Popup.superclass.init.call(this),r&&r.remove(),r=new Raphael("canvas_"+a),this},this.load=function(t,e,s,l){i=$.extend({},n,l),r.clear(),this.show(!0),r.setSize("100%","100%"),o=r.image(t,0,0,e,s);var u=$("#canvas_"+a),v=u.width(),g=u.height();return i.cropEnabled?(i.cropMinWidth<1&&(i.cropMinWidth=1),i.cropMinHeight<1&&(i.cropMinHeight=1),i.cropWidth<1&&(i.cropWidth=1),i.cropHeight<1&&(i.cropHeight=1),i.cropWidth>v&&(i.cropWidth=v),i.cropHeight>g&&(i.cropHeight=g)):($("#width_"+a).text(e),$("#height_"+a).text(s)),p((v-o.attrs.width)/2,(g-o.attrs.height)/2,i.angle,i.scale),this.get("rotate").el.off().on("slide",c).on("set",c).val(i.angle),this.get("zoom").el.off().on("slide",h).on("set",h).val(i.scale),this.get("btnApply").el.off("click",f).on("click",{useOriginal:!1},f),this.get("btnUseOriginal").el.off("click",f).on("click",{useOriginal:!0},f),d(),this},this.getTransformData=function(){if(!o)return[];var t={};if(i.cropEnabled){var e=o.getBBox(),r=$("#crop_"+a),s=r.position();t.cropLeft=s.left-e.x,t.cropTop=s.top-e.y,t.cropWidth=r.width(),t.cropHeight=r.height()}return t.angle=-i.angle,t.scale=i.scale/100,t.bgcolor=this.get("bgcolor").value(),t.isSmartCrop=this.get("smartCrop").el.prop("checked")?1:0,t},this.remove=function(){return $(window).off("resize",l),this.hide(),Popup.superclass.remove.call(this),this}};$pom.registerControl("imgeditor",ImgEditor,Popup);var Validator=function(t,e){Validator.superclass.constructor.call(this,t,e),this.result={},this.setState=function(t){return 1==this.el.attr("data-hiding")?t?this.el.hide():this.el.show():this.el.html(t?"":this.el.attr("data-text")),this.el.attr("data-state",t?"1":""),this.el.trigger(t?"valid":"invalid",[this]),this},this.getState=function(){return"1"==this.el.attr("data-state")},this.getControls=function(){var t=this.el.attr("data-controls");return t?t.split(/\s*,\s*/):[]},this.getGroups=function(){return(this.el.attr("data-groups")||"default").split(/\s*,\s*/)},this.getMode=function(){return(this.el.attr("data-mode")||"AND").toUpperCase()},this.getIndex=function(){return parseInt(this.el.attr("data-index"))||0},this.hasGroup=function(t){var e=this.getGroups();if(!$.isArray(t))return $.inArray(t,e);for(var i=0;i<t.length;i++)if(-1!=$.inArray(t[i],e))return!0;return!1},this.lock=function(t){return t?this.el.attr("data-locked",1):this.el.removeAttr("data-locked"),this},this.isLocked=function(){return this.el.attr("data-locked")},this.clean=function(){return this.setState(!0)},this.validate=function(){this.result={};var t=this.getControls();if(0==t.length)return this.setState(!0),!0;var e,i,r;switch(this.getMode()){default:case"AND":for(i=!0,e=0;e<t.length;e++){if(r=this.pom.get(t[e]),!r)throw new Error("Control with ID = "+t[e]+" is not found.");this.result[r.el.attr("id")]=r.validate(this)?!0:i=!1}break;case"OR":for(i=!1,e=0;e<t.length;e++){if(r=this.pom.get(t[e]),!r)throw new Error("Control with ID = "+t[e]+" is not found.");this.result[r.el.attr("id")]=r.validate(this)?i=!0:!1}break;case"XOR":var o=0;for(e=0;e<t.length;e++){if(r=this.pom.get(t[e]),!r)throw new Error("Control with ID = "+t[e]+" is not found.");r.validate(this)?(this.result[r.el.attr("id")]=1>o,o++):this.result[r.el.attr("id")]=!1}i=1==o}return this.setState(i),i},this.refresh=function(t,e){return Validator.superclass.refresh.call(this,t,e),this.setState("1"==this.el.attr("data-state"))}};$pom.registerControl("validator",Validator);var VRequired=function(t,e){VRequired.superclass.constructor.call(this,t,e),this.check=function(t){return t===!1||t===!0?t:this.el.attr("data-trim")?""!=$.trim(t):""!=t}};$pom.registerValidator("vrequired",VRequired);var VRegExp=function(el,pom){VRegExp.superclass.constructor.call(this,el,pom),this.check=function(value){var flag,exp=this.el.attr("data-expression");return""==exp||"1"==this.el.attr("data-empty")&&""==value?!0:(eval("i"==exp.charAt(0)?"flag = !"+exp.substr(1)+".test(value);":"flag = "+exp+".test(value);"),flag)}};$pom.registerValidator("vregexp",VRegExp);var VEmail=function(t,e){VEmail.superclass.constructor.call(this,t,e)};$pom.registerValidator("vemail",VRegExp);var VCompare=function(t,e){VCompare.superclass.constructor.call(this,t,e),this.validate=function(){var t=this.getControls();if(this.result={},0==t.length)return this.setState(!0),!0;var e,i,r,o,s,a,n;switch(this.getMode()){default:case"AND":for(r=!0,e=0;e<t.length-1;e++){if(a=this.pom.get(t[e]),!a)throw new Error("Control with ID = "+t[e]+" is not found.");for(o=a.validate(this),i=e+1;i<t.length;i++){if(n=this.pom.get(t[i]),!n)throw new Error("Control with ID = "+t[i]+" is not found.");s=n.validate(this),this.result[t[e]]=this.result[t[i]]=o===s?!0:r=!1}}break;case"OR":for(r=!1,e=0;e<t.length-1;e++){if(a=this.pom.get(t[e]),!a)throw new Error("Control with ID = "+t[e]+" is not found.");for(o=a.validate(this),i=e+1;i<t.length;i++){if(n=this.pom.get(t[i]),!n)throw new Error("Control with ID = "+t[i]+" is not found.");s=n.validate(this),this.result[t[e]]=this.result[t[i]]=o===s?r=!0:!1}}break;case"XOR":var l=0;for(e=0;e<t.length-1;e++){if(a=this.pom.get(t[e]),!a)throw new Error("Control with ID = "+t[e]+" is not found.");for(o=a.validate(this),i=e+1;i<t.length;i++){if(n=this.pom.get(t[i]),!n)throw new Error("Control with ID = "+t[i]+" is not found.");s=n.validate(this),o===s?(this.result[t[e]]=this.result[t[i]]=1>l,l++):this.result[t[e]]=this.result[t[i]]=!1}}r=1==l}return this.setState(r),r},this.check=function(t){return"1"==this.el.attr("data-caseinsensitive")?(t+"").toLowerCase():t}};$pom.registerValidator("vcompare",VCompare);var VCustom=function(t,e){VCustom.superclass.constructor.call(this,t,e),this.validate=function(){var t,e=this.el.attr("data-clientfunction");if(e)return t=window[e](this),this.setState(t),t;var i=this.getControls();t=this.el.attr("data-serverfunction")?"1"==this.el.attr("data-state"):!0;for(var r=0;r<i.length;r++)this.result[i[r]]=t;return this.setState(t),!0}};$pom.registerValidator("vcustom",VCustom);