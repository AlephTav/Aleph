# Aleph\Core\Delegate #

## Общая информация ##

|||
| --- | --- |
| **Наследование** | no |
| **Дочерние классы** | no |
| **Интерфейсы** | Aleph\Core\IDelegate |
| **Файл** | lib/Core/Delegate.php |

**Delegate** раширяет понятие функции обратного вызова (callback) в PHP. В Aleph'е под делегатом понимается объект класса **Delegate** или строка определённого формата, которая представляет собой описание вызова некоторого метода класса или функции.

Делегат это своего рода псевдоним вызова метода или функции. Вы можете работать с ним точно также как с любым другим вызываемым (callable) объектом PHP.

Существует семь типов делегатов: 

1. **function** - вызов простой функции.
2. **class::method** - вызов статического метода класса.
3. **class->method** - вызов нестатического метода класса, конструктор которого не имеет обязательных аргументов.
4. **class[]** - вызов конструктора класса, который не имеет обязательных аргументов.
5. **class[n]** - вызов конструктора класса, который имеет **n** обязательных аргументов.
6. **class[n]->method** - вызов нестатического метода класса, который имеет **n** обязательных аргументов.
7. **class@cid->method** - вызов нестатического метода веб-контрола.

Здесь **function** - имя функции, **class** - имя класса, **method** - название метода класса, **n** - число обязательных параметров конструктора класса, **cid** - уникальный или логический идентификатор веб-контрола.

Помимо вышеперечисленных основных типов, существуют ещё два типа контекстно-зависимых делегатов:
- **::method** - если страничный класс определён (переменная `Aleph\MVC\Page::$current`), то такой делегат задаёт вызов статического метода страничного класса. Если же страничный класс не определён, то будет вызван статический метод класса **Aleph**.
- **->method** - аналогично предыдущему случаю, только касается нестатических методов.

## Общедоступные нестатические методы ##

### **__construct()**

```php
public void __construct(mixed $callback)
```

||||
| --- | --- | --- |
| **$callback** | mixed | строка делегата или любой другой вызываемый (callable) объект. |

Конструктор класса. Анализирует строку делегата и подготавливает делегат к вызову.

### **__toString()**

```php
public string __toString()
```

Возвращает строковое представление делегата. Если делегатом является замыкание, то метод вернёт строку "Closure".

### **__invoke()**

```php
public mixed __invoke(mixed $arg1, mixed $arg2, ...)
```

Позволяет обращаться к объекту класса **Delegate** как к функции. Параметры этого метода соответствуют параметрам метода класса или функции которые вызываются делегатом. Пример:

```php
// Создаёт делегат для метода "foo" класса "Test".
// Конструктор класса принимает два обязательных параметра.
$d = new Delegate('Test[2]->foo');
// Вызывает метод "foo" и передаёт ему параметр 'test'.
// Параметры 'a' и 'b' передаются в конструктор класса.
$d('a', 'b', 'test');
```

### **call()**

```php
public mixed call(array $args = null)
```

||||
| --- | --- | --- |
| **$args** | array | массив параметров делегируемого метода класса или функции. |

Вызывает делегируемый метод класса или функцию. Пример:

```php
// Создаёт делегат для метода "foo" класса "Test".
// Конструктор класса принимает два обязательных параметра.
$d = new Delegate('Test[2]->foo');
// Вызывает метод "foo" и передаёт ему параметр 'test'.
// Параметры 'a' и 'b' передаются в конструктор класса.
$d->call(['a', 'b', 'test']);
```

### **isPermitted()**

```php
public function isPermitted(array $permissions)
```

||||
| --- | --- | --- |
| **$permissions** | array | ограничения на вызов делегата. |

Проверяет может ли делегат быть вызван согласно заданным ограничениям. **$permissions** имеет следующую структуру:

```php
[
  'permitted' => ['regexp1', 'regexp2', ... ],
  'forbidden' => ['regexp1', 'regexp2', ...]
]
```

Если строковое представление делегата совпадает хотя бы с одним регулярным выражением из **permitted** списка и не совпадает ни с одним регулярным выражением из **forbidden** списка, то метод вернёт TRUE. В противном случае метод возвращает FALSE.

### **isCallable()**

```php
public boolean isCallable(boolean $autoload = true)
```

||||
| --- | --- | --- |
| **$autoload** | boolean | определяет, следует ли подгружать делегируемый класс, если он не определён. |

Метод возвращает TRUE, если делегируемый метод класса или функция могут быть вызваны и FALSE в противном случае.

### **getInfo()**

```php
public array getInfo()
```

Возвращает подробную информацию о делегате. Возвращаемый массив имеет следующий формат: 

```php
['class'   => ... [string] ..., 
 'method'  => ... [string] ...,
 'static'  => ... [boolean] ...,
 'numargs' => ... [integer] ...,
 'type'    => ... [string] ...,
 'cid'     => ... [string] ...]
```

Здесь **class** - имя класса делегируемого метода, **method** - название метода или функции, **static** - признак статичного метода, **numargs** - число обязательных аргументов конструктора класса, **type** - тип делегата, **cid** - уникальный или логический идентификатор веб-контрола.

### **getClass()**

```php
public string getClass()
```

Возвращает название делегируемого класса.

### **getMethod()**

```php
public string getMethod()
```

Возвращает имя делегируемого метода или функции. 

### **getType()**

```php
public string getType()
```

Возвращает тип делегата - одно из возможных значений: "function", "closure", "class" or "control".

### **getParameters()**

```php
public array|boolean getParameters()
```

Возвращает массив параметров делегируемого метода класса, функции или замыкания и FALSE в случае ошибки. Каждый элемент возвращаемого массива представляет собой экземпляр класса **ReflectionParameter**.

### **getClassObject()**

```
public object getClassObject(array $args = null)
```

||||
| --- | --- | --- |
| **$args** | array | массив параметров конструктора делегируемого класса. |

Возвращает объект делегируемого класса. Если тип делегата "function", то метод вернёт NULL. Для делегата типа "control" метод возвращает объект веб-контрола (или FALSE, если контрол с заданным ID не существует).

## Защищённые нестатические свойства ##

### **callback**

```php
protected string $callback
```

Строка представляющая делегат.

### **class**

```php
protected string $class
```

Имя делегируемого класса.

### **method**

```php
protected string $method
```

Имя делегируемого метода класса или функции.

### **static**

```php
protected boolean $static
```

Содержит TRUE, если делегируемый метод статический. Если тип делегата "function" или "closure", значением свойства будет NULL.

### **numargs**

```php
protected integer $numargs
```

Число обязательных аргументов конструктора делегируемого класса. Если тип делегата "function" или "closure", значением свойства будет NULL.

### **cid**

```php
protected string $cid
```

Уникальный или логический идентификатор веб-контрола.

### **type**

```php
protected string $type
```

Тип делегата.